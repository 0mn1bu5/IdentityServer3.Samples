(function(){"use strict";function e(n,t){t=t||{};for(var i in n)n.hasOwnProperty(i)&&(t[i]=n[i]);return t}function n(n){this._settings=n||{};this._settings.authority&&this._settings.authority.indexOf(".well-known/openid-configuration")<0&&(this._settings.authority[this._settings.authority.length-1]!="/"&&(this._settings.authority+="/"),this._settings.authority+=".well-known/openid-configuration");this._settings.response_type||(this._settings.response_type="id_token token");this._settings.store||(this._settings.store=window.localStorage)}function o(){return((Date.now()+Math.random())*Math.random()).toString().replace(".","")}function f(n,t){return new Promise(function(i,r){var u=new XMLHttpRequest;u.open("GET",n);u.responseType="json";t&&u.setRequestHeader("Authorization","Bearer "+t);u.onload=function(){if(u.status===200){var n=u.response;typeof n=="string"&&(n=JSON.parse(n));i(n)}else r(Error(u.statusText+"("+u.status+")"))};u.onerror=function(){r(Error("Network error"))};u.send()})}function i(n,t,i,r){this.id_token=n;this.id_token_jwt=t;this.access_token=i;this.expires_at=parseInt(r);Object.defineProperty(this,"expired",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at<n}});Object.defineProperty(this,"expires_in",{get:function(){var n=parseInt(Date.now()/1e3);return this.expires_at-n}})}function s(n){this.url=n}function t(n){this._settings=n||{};this._settings.persist=this._settings.persist||!0;this._settings.store=this._settings.store||window.localStorage;this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[]};Object.defineProperty(this,"id_token",{get:function(){if(this._token)return this._token.id_token}});Object.defineProperty(this,"id_token_jwt",{get:function(){if(this._token)return this._token.id_token_jwt}});Object.defineProperty(this,"access_token",{get:function(){if(this._token&&!this._token.expired)return this._token.access_token}});Object.defineProperty(this,"expired",{get:function(){return this._token?this._token.expired:!0}});Object.defineProperty(this,"expires_in",{get:function(){return this._token?this._token.expires_in:0}});Object.defineProperty(this,"expires_at",{get:function(){return this._token?this._token.expires_at:0}});h(this);w(this);p(this);var t=this;window.setTimeout(function(){y(t)},0)}function h(n){var t,u;n._settings.persist&&(t=n._settings.store.getItem(r),t&&(u=i.fromJSON(t),u.expired||(n._token=u)))}function c(n){n._callbacks.tokenRemovedCallbacks.forEach(function(n){n()})}function l(n){n._callbacks.tokenExpiringCallbacks.forEach(function(n){n()})}function a(n){n._callbacks.tokenExpiredCallbacks.forEach(function(n){n()})}function v(n){n._callbacks.tokenObtainedCallbacks.forEach(function(n){n()})}function y(n){function i(){t=null;l(n)}function r(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(i,n*1e3)}function u(){if(r(),!n.expired){var t=n.expires_in;t>60?f(t-60):i()}}var t=null;u();n.addOnTokenObtained(u);n.addOnTokenRemoved(r)}function p(n){n._settings.silent_redirect_uri&&n._settings.silent_renew&&n.addOnTokenExpiring(function(){n.renewTokenSilentAsync().catch(function(n){console.error(n.message||n)})})}function w(n){function u(){t=null;n._token&&n.saveToken(null);a(n)}function i(){t&&(window.clearTimeout(t),t=null)}function f(n){t=window.setTimeout(u,n*1e3)}function r(){i();n.expires_in>0&&f(n.expires_in+1)}var t=null;r();n.addOnTokenObtained(r);n.addOnTokenRemoved(i)}var u="OidcClient.requestDataKey",r;n.prototype.redirectForToken=function(){this.createTokenRequestAsync().then(function(n){window.location=n.url},function(n){console.error(n)})};n.prototype.redirectForLogout=function(n){var t=this._settings;this.loadMetadataAsync().then(function(i){i.end_session_endpoint||console.error("No end_session_endpoint in metadata");var r=i.end_session_endpoint;n&&t.post_logout_redirect_uri&&(r+="?post_logout_redirect_uri="+t.post_logout_redirect_uri,r+="&id_token_hint="+n);window.location=r},function(n){console.error(n)})};n.prototype.loadAuthorizationEndpoint=function(n){return(n=n||this._settings,n.authorization_endpoint)?Promise.resolve(n.authorization_endpoint):n.authority?this.loadMetadataAsync(n).then(function(n){return n.authorization_endpoint?n.authorization_endpoint:Promise.reject("Metadata does not contain authorization_endpoint")}):Promise.reject(Error("No authorization_endpoint configured"))};n.prototype.createTokenRequestAsync=function(n){return n=n||this._settings,this.loadAuthorizationEndpoint(n).then(function(t){var f=o(),e=o(),i=t+"?state="+encodeURIComponent(f)+"&nonce="+encodeURIComponent(e),s,r;return["client_id","redirect_uri","response_type","scope"].forEach(function(t){var r=n[t];r&&(i+="&"+t+"="+encodeURIComponent(r))}),s=["prompt","display","max_age","ui_locales","id_token_hint","login_hint","acr_values"],s.forEach(function(t){var r=n[t];r&&(i+="&"+t+"="+encodeURIComponent(r))}),r={state:f,nonce:e},n.store.setItem(u,JSON.stringify(r)),{data:r,url:i}})};n.prototype.parseResult=function(n){var t,e;n=n||location.hash;t=n.lastIndexOf("#");t>=0&&(n=n.substr(t+1));for(var i={},u=/([^&=]+)=([^&]*)/g,r,f=0;r=u.exec(n);)if(i[decodeURIComponent(r[1])]=decodeURIComponent(r[2]),f++>50)return{error:"Response exceeded expected number of parameters"};for(e in i)return i};n.prototype.loadMetadataAsync=function(n){return n=n||this._settings,n.metadata&&Promise.resolve(n.metadata),n.authority||Promise.reject(Error("No authority configured")),f(n.authority).then(function(t){return n.metadata=t,t},function(n){Promise.reject(Error("Failed to load metadata ("+n.message+")"))})};n.prototype.loadX509SigningKeyAsync=function(n){function t(n){if(!n.keys||!n.keys.length)return Promise.reject(Error("Signing keys empty"));var t=n.keys[0];return t.kty!="RSA"?Promise.reject(Error("Signing key not RSA")):!t.x5c||!t.x5c.length?Promise.reject(Error("RSA keys empty")):Promise.resolve(t.x5c[0])}return(n=n||this._settings,n.jwks)?t(n.jwks):this.loadMetadataAsync(n).then(function(i){return i.jwks_uri?f(i.jwks_uri).then(function(i){return n.jwks=i,t(i)},function(n){return Promise.reject(Error("Failed to load signing keys ("+n.message+")"))}):Promise.reject(Error("Metadata does not contain jwks_uri"))})};n.prototype.validateJwtAsync=function(n,t){return this.loadX509SigningKeyAsync(t).then(function(t){var i=new KJUR.jws.JWS;return i.verifyJWSByPemX509Cert(n,t)?JSON.parse(i.parsedJWS.payloadS):Promise.reject(Error("JWT failed to validate"))})};n.prototype.validateAccessTokenAsync=function(n,t,i){return n.at_hash?this.loadX509SigningKeyAsync().then(function(r){var u=new KJUR.jws.JWS;if(u.verifyJWSByPemX509Cert(t,r)){if(u.parsedJWS.headP.alg!="RS256")return Promise.reject(Error("JWT signature alg not supported"));var f=KJUR.crypto.Util.sha256(i),e=f.substr(0,f.length/2),o=hextob64u(e);if(o!==n.at_hash)return Promise.reject(Error("at_hash failed to validate"))}else return Promise.reject(Error("JWT failed to validate"))}):Promise.reject("No at_hash in id_token")};n.prototype.loadUserProfile=function(n,t){var i=this._settings;return this.loadMetadataAsync(i).then(function(i){return i.userinfo_endpoint?f(i.userinfo_endpoint,n).then(function(n){return e(n,t)}):Promise.reject(Error("Metadata does not contain userinfo_endpoint"))})};n.prototype.readResponseAsync=function(t){function r(n){return Promise.reject(Error(n))}var o=this,h=o._settings,e=h.store.getItem(u),f,s,c;return(h.store.removeItem(u),!e)?r("No request state loaded"):(e=JSON.parse(e),!e)?r("No request state loaded"):e.state?e.nonce?(f=n.prototype.parseResult(t),!f)?r("No OIDC response"):f.error?r(f.error):f.state!==e.state?r("Invalid state"):(s=f.access_token,!s)?r("No access token"):f.token_type!=="Bearer"?r("Invalid token type"):(c=f.expires_in,!c)?r("No token expiration"):f.id_token?o.validateJwtAsync(f.id_token).then(function(n){return n?e.nonce!==n.nonce?r("Invalid nonce"):o.loadMetadataAsync().then(function(t){if(n.iss!==t.issuer)return r("Invalid issuer");if(n.aud!==h.client_id)return r("Invalid audience");var u=parseInt(Date.now()/1e3),e=u-n.iat;return e>300?r("Token issued too long ago"):n.exp<u?r("Token expired"):o.validateAccessTokenAsync(n,f.id_token,s).then(function(){return o.loadUserProfile(s,n).then(function(n){return i.fromResponse({id_token:n,id_token_jwt:f.id_token,access_token:s,expires_in:c})})})}):r("Invalid identity token")}):r("No identity token"):r("No nonce loaded"):r("No state loaded")};i.fromResponse=function(n){var t=parseInt(Date.now()/1e3),r=t+parseInt(n.expires_in);return new i(n.id_token,n.id_token_jwt,n.access_token,r)};i.fromJSON=function(n){if(n)try{var t=JSON.parse(n);return new i(t.id_token,t.id_token_jwt,t.access_token,t.expires_at)}catch(r){}return new i(null,0,null)};i.prototype.toJSON=function(){return JSON.stringify({id_token:this.id_token,id_token_jwt:this.id_token_jwt,access_token:this.access_token,expires_at:this.expires_at})};s.prototype.loadAsync=function(n){return(n=n||this.url,!n)?Promise.reject("No url provided"):new Promise(function(t,i){function f(){window.removeEventListener("message",e,!1);r&&window.clearTimeout(r);r=null;u.remove()}function o(){f();i()}function e(n){r&&n.origin===location.protocol+"//"+location.host&&(f(),t(n.data))}var u=$('<iframe style="display:none"><\/iframe>').appendTo("body"),r=window.setTimeout(o,5e3);window.addEventListener("message",e,!1);u.attr("src",n)})};r="TokenManager.token";t.prototype.saveToken=function(n){this._token=n;this._settings.persist&&!this.expired?this._settings.store.setItem(r,n.toJSON()):this._settings.store.removeItem(r);n?v(this):c(this)};t.prototype.addOnTokenRemoved=function(n){this._callbacks.tokenRemovedCallbacks.push(n)};t.prototype.addOnTokenObtained=function(n){this._callbacks.tokenObtainedCallbacks.push(n)};t.prototype.addOnTokenExpiring=function(n){this._callbacks.tokenExpiringCallbacks.push(n)};t.prototype.addOnTokenExpired=function(n){this._callbacks.tokenExpiredCallbacks.push(n)};t.prototype.removeToken=function(){this.saveToken(null)};t.prototype.redirectForToken=function(){var t=new n(this._settings);t.redirectForToken()};t.prototype.redirectForLogout=function(){var t=new n(this._settings),i=this.id_token_jwt;this.removeToken();t.redirectForLogout(i)};t.prototype.processTokenCallbackAsync=function(t){var i=this,r=new n(i._settings);return r.readResponseAsync(t).then(function(n){i.saveToken(n)})};t.prototype.renewTokenSilentAsync=function(){var i=this,t,r;return i._settings.silent_redirect_uri?(t=e(i._settings),t.redirect_uri=t.silent_redirect_uri,t.prompt="none",r=new n(t),r.createTokenRequestAsync().then(function(n){var t=new s(n.url);return t.loadAsync().then(function(n){return r.readResponseAsync(n).then(function(n){i.saveToken(n)})})})):Promise.reject("silent_redirect_uri not configured")};t.prototype.processTokenCallbackSilent=function(){if(window.top&&window!==window.top){var n=window.location.hash;n&&window.top.postMessage(n,location.protocol+"//"+location.host)}};window.TokenManager=t})();